name: Lint
on:
  - push
  - pull_request
concurrency:
  group: ${{ github.workflow }}-{{ github.head_ref || github.ref }}
  cancel-in-progress: true
env:
  os: ubuntu-20.04
  ruby: 2.7
jobs:
  rubocop:
    name: RuboCop
    runs-on: ubuntu-20.04
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    - name: Setup ruby
      uses: actions/setup-ruby@v1.1.3
      with:
        ruby-version: ${{ env.ruby }}
    - name: Cache gems
      uses: actions/cache@v3
      with:
        path: vendor/bundle
        key: bundle-${{ env.os }}-${{ env.ruby }}-${{ hashFiles('Gemfile.lock') }}
        restore-keys: |
          bundle-${{ env.os }}-${{ env.ruby }}-
    - name: Install gems
      run: |
        gem install bundler
        bundle config set deployment true
        bundle install --jobs 4 --retry 3
    - name: Run rubocop
      run: bundle exec rubocop --format fuubar
  erblint:
    name: ERB Lint
    runs-on: ubuntu-20.04
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    - name: Setup ruby
      uses: actions/setup-ruby@v1.1.3
      with:
        ruby-version: ${{ env.ruby }}
    - name: Cache gems
      uses: actions/cache@v3
      with:
        path: vendor/bundle
        key: bundle-${{ env.os }}-${{ env.ruby }}-${{ hashFiles('Gemfile.lock') }}
        restore-keys: |
          bundle-${{ env.os }}-${{ env.ruby }}-
    - name: Install gems
      run: |
        gem install bundler
        bundle config set deployment true
        bundle install --jobs 4 --retry 3
    - name: Run erblint
      run: bundle exec erblint .
  eslint:
    name: ESLint
    runs-on: ubuntu-20.04
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    - name: Setup ruby
      uses: actions/setup-ruby@v1.1.3
      with:
        ruby-version: ${{ env.ruby }}
    - name: Cache gems
      uses: actions/cache@v3
      with:
        path: vendor/bundle
        key: bundle-${{ env.os }}-${{ env.ruby }}-${{ hashFiles('Gemfile.lock') }}
        restore-keys: |
          bundle-${{ env.os }}-${{ env.ruby }}-
    - name: Cache yarn
      uses: actions/cache@v3
      with:
        path: .yarn
        key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-yarn-
    - name: Install gems
      run: |
        gem install bundler
        bundle config set deployment true
        bundle install --jobs 4 --retry 3
    - name: Install node modules
      run: corepack enable && bundle exec rake yarn:install
    - name: Create dummy database configuration
      run: cp config/example.database.yml config/database.yml
    - name: Run eslint
      run: bundle exec rake eslint
  brakeman:
    name: Brakeman
    runs-on: ubuntu-20.04
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    - name: Setup ruby
      uses: actions/setup-ruby@v1.1.3
      with:
        ruby-version: ${{ env.ruby }}
    - name: Cache gems
      uses: actions/cache@v3
      with:
        path: vendor/bundle
        key: bundle-${{ env.os }}-${{ env.ruby }}-${{ hashFiles('Gemfile.lock') }}
        restore-keys: |
          bundle-${{ env.os }}-${{ env.ruby }}-
    - name: Install gems
      run: |
        gem install bundler
        bundle config set deployment true
        bundle install --jobs 4 --retry 3
    - name: Run brakeman
      run: bundle exec brakeman -q
