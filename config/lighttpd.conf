#
# Load the modules that we need
#
server.modules = ( 
  "mod_access",
  "mod_accesslog",
  "mod_cgi",
  "mod_compress",
  "mod_evasive",
  "mod_expire",
  "mod_fastcgi",
  "mod_redirect",
  "mod_status"
)

#
# Basic server configuration
#
server.username = "www-data"
server.groupname = "www-data"
server.pid-file = "/var/run/lighttpd.pid"

server.max-fds = 8192

#
# Setup logging
#
accesslog.filename = "/var/log/lighttpd/access.log"
server.errorlog = "/var/log/lighttpd/error.log"

#
# Allow munin to monitor the server's status
#
$HTTP["remoteip"] == "127.0.0.1" { 
  status.config-url = "/server-config"
  status.status-url = "/server-status"
  status.statistics-url = "/server-statistics"
}

#
# IP blocked at SteveC's request as it was trying to download the
# history of every object in the database one at a time
#
$HTTP["remoteip"] == "143.210.16.160" { url.access-deny = ("") }

#
# Rule to block tilesAtHome when somebody decides to queue vast 
# number of tiles for rerendering
#
#$HTTP["useragent"] == "tilesAtHome" { url.access-deny = ("") }

#
# Limit connections to 20 per IP address
#
evasive.max-conns-per-ip = 20

#
# Setup MIME type mapping
#
mimetype.assign = (
  ".css" => "text/css",
  ".gif" => "image/gif",
  ".html" => "text/html; charset=utf-8",
  ".js" => "application/x-javascript",
  ".png" => "image/png",
  ".swf" => "application/x-shockwave-flash",
  ".txt" => "text/plain",
  ".xml" => "text/xml"
)

#
# Force special MIME type for crossdomain.xml files
#
$HTTP["url"] =~ "/crossdomain\.xml$" {
  mimetype.assign = ( ".xml" => "text/x-cross-domain-policy" )
}

#
# Enable compression of appropriate static content
#
compress.filetype = ( 
  "application/x-javascript",
  "application/x-shockwave-flash",
  "text/css",
  "text/html",
  "text/plain"
)

#
# Set expiry for static content
#
expire.url = (
  "/export/" => "access 7 days",
  "/images/" => "access 10 years",
  "/javascripts/" => "access 10 years",
  "/openlayers/" => "access 7 days",
  "/stylesheets/" => "access 10 years"
)

#
# Cache compressed content
#
compress.cache-dir = "/var/cache/lighttpd"

#
# Redirect trac and wiki requests to the right places
#
url.redirect = ( 
  "^/trac/(.*)$" => "http://trac.openstreetmap.org/$1",
  "^/wiki/(.*)$" => "http://wiki.openstreetmap.org/$1"
)

#
# Redirect everything except www.openstreetmap.org and
# api.openstreetmap.org to www.openstreetmap.org
#
$HTTP["host"] =~ "^api\." {
  $HTTP["host"] != "api.openstreetmap.org" {
    url.redirect = ( "^(.*)$" => "http://api.openstreetmap.org$1" )
  }
}
else $HTTP["host"] != "www.openstreetmap.org" {
  url.redirect = ( "^(.*)$" => "http://www.openstreetmap.org$1" )
} 

#
# Run anything with a .pl iextension as a CGI script
#
cgi.assign = ( ".pl" => "/usr/bin/perl" )

#
# Serve static content from the rails public area ourselves
#
server.document-root = "/home/rails/public"

#
# Send everything else to the appropriate FastCGI server
#
$HTTP["useragent"] == "tilesAtHome" {
  server.error-handler-404 = "/dispatch.tah"
}
else $HTTP["url"] =~ "^/api/0\.6/(map|trackpoints|amf|amf/read|swf/trackpoints)$" {
  server.error-handler-404 = "/dispatch.bulkapi"
}
else $HTTP["url"] =~ "^/api/0\.6/.*/search$" {
  server.error-handler-404 = "/dispatch.bulkapi"
}
else $HTTP["url"] =~ "^/api/0\.6/" {
  server.error-handler-404 = "/dispatch.api"
}
else $HTTP["url"] =~ "^/api/0\.[0-9]+/" {
  url.access-deny = ("")
}
else $HTTP["url"] =~ "^/" {
  server.error-handler-404 = "/dispatch.web"
}

#
# Configure the FastCGI servers
#
fastcgi.server = ( 
  ".web" => (
    ( "host" => "127.0.0.1", "port" => 8000, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8001, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8002, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8003, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8004, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8005, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8006, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8007, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8008, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8009, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8010, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8011, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8012, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8013, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8014, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8015, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8016, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8017, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8018, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8019, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8020, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8021, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8022, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8023, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8024, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8025, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8026, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8027, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8028, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8029, "check-local" => "disable" )
  ),
  ".api" => (
    ( "host" => "127.0.0.1", "port" => 8030, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8031, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8032, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8033, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8034, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8035, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8036, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8037, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8038, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8039, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8040, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8041, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8042, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8043, "check-local" => "disable" ),
    ( "host" => "127.0.0.1", "port" => 8044, "check-local" => "disable" )
  ),
  ".bulkapi" => (
    ( "host" => "10.0.0.10", "port" => 8000, "check-local" => "disable" ),
    ( "host" => "10.0.0.11", "port" => 8000, "check-local" => "disable" ),
    ( "host" => "10.0.0.12", "port" => 8000, "check-local" => "disable" ),
    ( "host" => "10.0.0.10", "port" => 8001, "check-local" => "disable" ),
    ( "host" => "10.0.0.11", "port" => 8001, "check-local" => "disable" ),
    ( "host" => "10.0.0.12", "port" => 8001, "check-local" => "disable" ),
    ( "host" => "10.0.0.10", "port" => 8002, "check-local" => "disable" ),
    ( "host" => "10.0.0.11", "port" => 8002, "check-local" => "disable" ),
    ( "host" => "10.0.0.12", "port" => 8002, "check-local" => "disable" ),
    ( "host" => "10.0.0.10", "port" => 8003, "check-local" => "disable" ),
    ( "host" => "10.0.0.11", "port" => 8003, "check-local" => "disable" ),
    ( "host" => "10.0.0.12", "port" => 8003, "check-local" => "disable" )
  ),
  ".tah" => (
    ( "host" => "10.0.0.10", "port" => 8004, "check-local" => "disable" ),
    ( "host" => "10.0.0.11", "port" => 8004, "check-local" => "disable" ),
    ( "host" => "10.0.0.12", "port" => 8004, "check-local" => "disable" ),
    ( "host" => "10.0.0.10", "port" => 8005, "check-local" => "disable" ),
    ( "host" => "10.0.0.11", "port" => 8005, "check-local" => "disable" ),
    ( "host" => "10.0.0.12", "port" => 8005, "check-local" => "disable" )
  )
)
